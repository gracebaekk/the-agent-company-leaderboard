name: Run Assessment

on:
  push:
    branches:
      - main
      - 'submission/**'
    paths:
      - 'scenario.toml'
  workflow_dispatch:

jobs:
  run-assessment:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install tomli tomli-w requests pyyaml
      
      - name: Generate Docker Compose configuration
        run: |
          python generate_compose.py --scenario scenario.toml
        env:
          GITHUB_ACTIONS: true
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Run assessment
        run: |
          mkdir -p output
          docker compose up --abort-on-container-exit
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      
      - name: Check for results
        id: check_results
        run: |
          if [ -f "output/results.json" ]; then
            echo "results_exist=true" >> $GITHUB_OUTPUT
          else
            echo "results_exist=false" >> $GITHUB_OUTPUT
            echo "Error: No results.json found in output directory"
            exit 1
          fi
      
      - name: Record provenance
        if: steps.check_results.outputs.results_exist == 'true'
        run: |
          python record_provenance.py --compose docker-compose.yml --output output/provenance.json
      
      - name: Generate submission ID
        id: submission_id
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BRANCH_NAME="${GITHUB_REF##*/}"
          SUBMISSION_ID="${BRANCH_NAME}-${TIMESTAMP}"
          echo "submission_id=${SUBMISSION_ID}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
      
      - name: Copy files to submissions directory
        if: steps.check_results.outputs.results_exist == 'true'
        run: |
          SUBMISSION_DIR="submissions/${{ steps.submission_id.outputs.submission_id }}"
          mkdir -p "$SUBMISSION_DIR"
          cp output/results.json "$SUBMISSION_DIR/results.json"
          cp output/provenance.json "$SUBMISSION_DIR/provenance.json"
          cp scenario.toml "$SUBMISSION_DIR/scenario.toml"
          cp a2a-scenario.toml "$SUBMISSION_DIR/a2a-scenario.toml"
      
      - name: Copy results to results directory
        if: steps.check_results.outputs.results_exist == 'true'
        run: |
          mkdir -p results
          cp "submissions/${{ steps.submission_id.outputs.submission_id }}/results.json" "results/${{ steps.submission_id.outputs.submission_id }}.json"
      
      - name: Create submission branch
        if: steps.check_results.outputs.results_exist == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          BRANCH_NAME="submission/${{ steps.submission_id.outputs.submission_id }}"
          git checkout -b "$BRANCH_NAME"
          
          git add submissions/${{ steps.submission_id.outputs.submission_id }}/
          git add results/${{ steps.submission_id.outputs.submission_id }}.json
          
          git commit -m "Add assessment results for ${{ steps.submission_id.outputs.submission_id }}"
          git push origin "$BRANCH_NAME"
      
      - name: Create Pull Request
        if: steps.check_results.outputs.results_exist == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const submissionId = '${{ steps.submission_id.outputs.submission_id }}';
            const branchName = `submission/${submissionId}`;
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Assessment Results: ${submissionId}`,
              head: branchName,
              base: 'main',
              body: `## Assessment Results\n\n**Submission ID:** ${submissionId}\n**Timestamp:** ${{ steps.submission_id.outputs.timestamp }}\n\n### Files Included\n- \`results.json\` - Assessment results from green agent\n- \`provenance.json\` - Docker image digests and timestamp\n- \`scenario.toml\` - Assessment configuration\n- \`a2a-scenario.toml\` - A2A protocol configuration\n\n### Next Steps\n1. Review the results\n2. Merge this PR to add the results to the leaderboard\n3. AgentBeats will automatically update the leaderboard after merge\n\n---\n*This PR was automatically generated by the assessment runner.*`
            });
            
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: assessment-output-${{ steps.submission_id.outputs.submission_id }}
          path: |
            output/
            docker-compose.yml
            a2a-scenario.toml
          retention-days: 30
      
      - name: Comment PR with results link
        if: steps.check_results.outputs.results_exist == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('output/results.json', 'utf8'));
            
            let comment = '## ðŸŽ¯ Assessment Complete!\n\n';
            comment += '### Submit your results\n\n';
            comment += 'Your assessment has been successfully completed. ';
            comment += 'A pull request has been created with your results.\n\n';
            comment += '**To add these results to the leaderboard:**\n';
            comment += '1. Review the results in the PR\n';
            comment += '2. Merge the PR\n';
            comment += '3. The leaderboard will automatically update via webhook\n\n';
            comment += '---\n';
            comment += '*Assessment ID: ${{ steps.submission_id.outputs.submission_id }}*';
            
            // If this was triggered by a PR, comment on it
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }

